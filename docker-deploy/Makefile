# Makefile for Android WebView Builder Docker Operations

# é»˜è®¤é…ç½®ï¼ˆå¯é€šè¿‡å‘½ä»¤è¡Œè¦†ç›–ï¼‰
DOCKER_USERNAME ?= yourusername
IMAGE_NAME ?= android-webview-builder
VERSION ?= 1.0.0
PORT ?= 8080

# é•œåƒæ ‡ç­¾
LOCAL_IMAGE = $(IMAGE_NAME):$(VERSION)
REMOTE_IMAGE = $(DOCKER_USERNAME)/$(IMAGE_NAME):$(VERSION)
REMOTE_IMAGE_LATEST = $(DOCKER_USERNAME)/$(IMAGE_NAME):latest

.PHONY: help build run push push-latest clean deploy all

# é»˜è®¤ç›®æ ‡ï¼šæ˜¾ç¤ºå¸®åŠ©
help:
	@echo "Android WebView Builder - Dockerç®¡ç†å‘½ä»¤"
	@echo ""
	@echo "ä½¿ç”¨æ–¹æ³•: make [å‘½ä»¤] [é€‰é¡¹]"
	@echo ""
	@echo "å‘½ä»¤:"
	@echo "  make build          - æ„å»ºDockeré•œåƒ"
	@echo "  make run            - æœ¬åœ°è¿è¡Œå®¹å™¨"
	@echo "  make push           - æ¨é€åˆ°Docker Hubï¼ˆéœ€è¦å…ˆç™»å½•ï¼‰"
	@echo "  make push-latest    - æ¨é€ç‰ˆæœ¬å·å’Œlatestæ ‡ç­¾"
	@echo "  make deploy         - æ„å»ºå¹¶è¿è¡Œ"
	@echo "  make all            - æ„å»ºã€æ¨é€å¹¶è¿è¡Œ"
	@echo "  make clean          - æ¸…ç†å®¹å™¨å’Œé•œåƒ"
	@echo "  make logs           - æŸ¥çœ‹å®¹å™¨æ—¥å¿—"
	@echo "  make stop           - åœæ­¢å®¹å™¨"
	@echo "  make restart        - é‡å¯å®¹å™¨"
	@echo ""
	@echo "é€‰é¡¹:"
	@echo "  DOCKER_USERNAME=xxx - Docker Hubç”¨æˆ·åï¼ˆé»˜è®¤: $(DOCKER_USERNAME)ï¼‰"
	@echo "  IMAGE_NAME=xxx      - é•œåƒåç§°ï¼ˆé»˜è®¤: $(IMAGE_NAME)ï¼‰"
	@echo "  VERSION=xxx         - ç‰ˆæœ¬å·ï¼ˆé»˜è®¤: $(VERSION)ï¼‰"
	@echo "  PORT=xxx            - ç«¯å£å·ï¼ˆé»˜è®¤: $(PORT)ï¼‰"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make build"
	@echo "  make push DOCKER_USERNAME=myname VERSION=2.0.0"
	@echo "  make run PORT=9090"

# æ„å»ºé•œåƒ
build:
	@echo "ğŸ”¨ æ„å»ºDockeré•œåƒ: $(LOCAL_IMAGE)"
	@echo "ä½¿ç”¨è·¨å¹³å°Dockerfile (æ”¯æŒMac M1/M2å’Œx86_64)..."
	docker build -t $(LOCAL_IMAGE) -f Dockerfile.cross-platform .
	@echo "âœ… æ„å»ºå®Œæˆ"

# è¿è¡Œå®¹å™¨
run:
	@echo "ğŸš€ å¯åŠ¨å®¹å™¨: $(IMAGE_NAME)"
	@docker stop $(IMAGE_NAME) 2>/dev/null || true
	@docker rm $(IMAGE_NAME) 2>/dev/null || true
	docker run -d \
		--name $(IMAGE_NAME) \
		-p $(PORT):80 \
		-v $(PWD)/data:/app/data \
		--restart unless-stopped \
		$(LOCAL_IMAGE)
	@echo "âœ… å®¹å™¨å·²å¯åŠ¨"
	@echo "ğŸ“ è®¿é—®åœ°å€: http://localhost:$(PORT)"

# æ¨é€åˆ°Docker Hubï¼ˆä»…ç‰ˆæœ¬æ ‡ç­¾ï¼‰
push: build
	@echo "ğŸ“¤ æ¨é€é•œåƒåˆ°Docker Hub"
	@echo "ç›®æ ‡: $(REMOTE_IMAGE)"
	docker tag $(LOCAL_IMAGE) $(REMOTE_IMAGE)
	docker push $(REMOTE_IMAGE)
	@echo "âœ… æ¨é€å®Œæˆ"
	@echo "ğŸ”— https://hub.docker.com/r/$(DOCKER_USERNAME)/$(IMAGE_NAME)"

# æ¨é€ç‰ˆæœ¬å’Œlatestæ ‡ç­¾
push-latest: build
	@echo "ğŸ“¤ æ¨é€é•œåƒåˆ°Docker Hubï¼ˆåŒ…å«latestæ ‡ç­¾ï¼‰"
	docker tag $(LOCAL_IMAGE) $(REMOTE_IMAGE)
	docker tag $(LOCAL_IMAGE) $(REMOTE_IMAGE_LATEST)
	docker push $(REMOTE_IMAGE)
	docker push $(REMOTE_IMAGE_LATEST)
	@echo "âœ… æ¨é€å®Œæˆ"
	@echo "ğŸ”— https://hub.docker.com/r/$(DOCKER_USERNAME)/$(IMAGE_NAME)"

# éƒ¨ç½²ï¼ˆæ„å»ºå¹¶è¿è¡Œï¼‰
deploy: build run

# å®Œæ•´æµç¨‹ï¼ˆæ„å»ºã€æ¨é€ã€è¿è¡Œï¼‰
all: build push-latest run

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†å®¹å™¨å’Œé•œåƒ"
	@docker stop $(IMAGE_NAME) 2>/dev/null || true
	@docker rm $(IMAGE_NAME) 2>/dev/null || true
	@docker rmi $(LOCAL_IMAGE) 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æŸ¥çœ‹æ—¥å¿—
logs:
	docker logs -f $(IMAGE_NAME)

# åœæ­¢å®¹å™¨
stop:
	@echo "â¹ åœæ­¢å®¹å™¨"
	docker stop $(IMAGE_NAME)
	@echo "âœ… å·²åœæ­¢"

# é‡å¯å®¹å™¨
restart:
	@echo "ğŸ”„ é‡å¯å®¹å™¨"
	docker restart $(IMAGE_NAME)
	@echo "âœ… å·²é‡å¯"

# è¿›å…¥å®¹å™¨shell
shell:
	docker exec -it $(IMAGE_NAME) /bin/bash

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
status:
	@docker ps | grep $(IMAGE_NAME) || echo "å®¹å™¨æœªè¿è¡Œ"

# æ‹‰å–æœ€æ–°é•œåƒï¼ˆä»Docker Hubï¼‰
pull:
	docker pull $(REMOTE_IMAGE_LATEST)

# ä½¿ç”¨Docker Hubé•œåƒè¿è¡Œ
run-remote:
	@echo "ğŸš€ ä½¿ç”¨Docker Hubé•œåƒè¿è¡Œ"
	@docker stop $(IMAGE_NAME) 2>/dev/null || true
	@docker rm $(IMAGE_NAME) 2>/dev/null || true
	docker run -d \
		--name $(IMAGE_NAME) \
		-p $(PORT):80 \
		-v $(PWD)/data:/app/data \
		--restart unless-stopped \
		$(REMOTE_IMAGE_LATEST)
	@echo "âœ… å®¹å™¨å·²å¯åŠ¨"
	@echo "ğŸ“ è®¿é—®åœ°å€: http://localhost:$(PORT)"